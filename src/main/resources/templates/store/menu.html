<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org/">
<head>
<meta charset="UTF-8">
<meta name="viewport"
	content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"
	integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l"
	crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-3.6.0.js"
	integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk="
	crossorigin="anonymous"></script>
<script
	src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"
	integrity="sha384-Piv4xVNRyMGpqkS2by6br4gNJ7DXjqk09RmUpJ8jgGtD7zP9yug3goQfGII0yAns"
	crossorigin="anonymous"></script>
<script
	src="https://cdn.jsdelivr.net/npm/jquery-twzipcode@1.7.15-rc1/jquery.twzipcode.min.js" />
<script src="/js/jquery.twzipcode.min.js"></script>
<script>
$(function() {
// 	$(".butest").click(function() {
// 		$.ajax({
// 			type : "GET",
// 			url : "[[@{/store/getMenu}]]",
// 			dataType : "json",
// 			contentType : "application/json",
// 			success : function(response) {
// 				$.each(response, function(index, element){
// 				$('.info').append(
// 					'<tr><td>'+ [index+1] + '</td>'+
// 					'<td style="display: none" class="p">'+ element.pkDishId + '</td>'+
// 		        	'<td>'+ element.dishName + '</td>' +
// 		        	'<td>'+ element.dishIntroduction + '</td>' +
// 		        	'<td>'+ element.dishPrice + '</td>' +
// 		         	'<td><button class="delete">刪除</button></td></tr>')
// 					 }
// 				)}
// 			});
// 		})
	
	
 
 //刪除菜單
$(".delete").click(DeleteProduct)
	function DeleteProduct(){
		var b2 = confirm ("確定要刪除該筆資料嗎?")
 		if(b2){
			$(this).parent().parent().remove();
			//重新給予序號
			var num = $(".dishNum");
			for(i = 0; i < num.length; i++){
				num.eq(i).text(i+1)
			}
 			var menuID = $(this).parent().parent().find(".p").text()
 			$.ajax({ type: "GET", 
 					url: "[[@{/store/delete/}]]"+ menuID
 				});		
 			}
		}

//新增一行可輸入的菜單
let newLineStr = "<tr class='menuInp'><td><input type='text' class='classinp DN' name='dishName' placeholder='菜品名稱'></td><td><input type='text' class='classinp DI' name='dishIntroduction' placeholder='菜品說明'><td><input type='text' class='classinp DP' name='dishPrice' placeholder='菜品價格'><span class='text-danger'></span></td><td><button class='deleteLine btn btn-danger'>刪除</button></td></tr>"
$(".addNewLine").click(function() {
	let ObjInput=document.getElementsByTagName("input") ;
	$("#submitButt").attr("hidden", false);
	$('#newDishForm').append(newLineStr);
// 	var flag = false; 
// 	for(i=0;i <ObjInput.length;i++){ 
// 	    if(ObjInput[i].type== "text"){ 
// 	        if(ObjInput[i].value==''){
// 	            flag = true;
// 	            break ;
// 	        }
// 	    } 
// 	}
// 	if(flag){
// 		confirm ("請先填完後再新增")
// 	}else{
// 		$('#newDishForm').append(newLineStr);
// 	}
});
//將新增後的一行刪除
$(".addDishPlace").on("click", ".deleteLine", function() {
	$(this).closest("tr").remove();
	let ObjSub = $(".classinp").val();
	if(ObjSub == null || ObjSub.value == ''){
		$("#submitButt").attr("hidden", true);
	}
})

//將菜單透過AJAX方式傳到後端
$("#submitButt").click(function(){
	var saveMenu = [];
	
	var  allDishlength =$("#newDishForm").find(".menuInp").length;
	
	for(i=0; i < allDishlength; i++){
		
		var allDish = $(".menuInp");
		
		saveMenu[saveMenu.length] = {
				"dishName" : $(".DN").eq(i).val(),    
				"dishIntroduction" : $(".DI").eq(i).val(),
				"dishPrice" : $(".DP").eq(i).val()
				};
		
	}
	//判斷書入欄位是否有空值
	var flag = false;
	for(i = 0; i < allDishlength; i++){
		for(let obj in saveMenu[i]){
			if(saveMenu[i][obj] == ''){
				flag = true;
			}
		}
		//判斷價格欄位是否為數字
		re = /^[0-9]*$/;
		if(!re.test(saveMenu[i].dishPrice)){
			 $(".DP").eq(i).parent().find("span").html("請填入數字");
			 flag = true;
		}
	}
	if(!flag){
		$.ajax({ type: "POST", 
			url:"[[@{/store/saveMenu}]]",
			data: JSON.stringify(saveMenu), dataType: "json", 
			contentType: "application/json",
		});	
		alert('已新增菜單');
		location.reload();
	}else{
		$('.alertEmp').html("<strong class='text-danger'>請確認欄位是否有空白</strong>");
	}
		
})

//修改紐
$(".modify").click(function(){
	let pkDishId, dishName, dishIntroduction, dishPrice;
	dishNum = $(this).parent().siblings().eq(0).text();
	pkDishId = $(this).parent().siblings().eq(1).text();
	dishName = $(this).parent().siblings().eq(2).text();
	dishIntroduction = $(this).parent().siblings().eq(3).text();
	dishPrice = $(this).parent().siblings().eq(4).text();
	
	let dishString = "<td>" + dishNum + "</td><td style='display: none'>" + pkDishId + "</td><td><input type='text' name='dishNameMod' value='" + dishName + "'></td><td><input type='text' name='dishIntroductionMod' value='" + dishIntroduction + "'></td><td><input type='text' name='dishPriceMod' value='" + dishPrice + "'></td><td><button class='modiCom btn btn-primary'>送出</button><button class='cancel btn btn-secondary'>取消</button></td>"
	$(this).parent().parent().html(dishString);
})

//修改後按下確認
$(".info").on("click", ".modiCom", function() {
	var saveModiMenu = [];
	saveModiMenu = {
			"pkDishId" : $(this).parent().siblings().eq(1).text(),
			"dishName" : $(this).parent().siblings().eq(2).find("input").val(),    
			"dishIntroduction" : $(this).parent().siblings().eq(3).find("input").val(),
			"dishPrice" : $(this).parent().siblings().eq(4).find("input").val()
			};
	
	$.ajax({ type: "POST", 
		url:"[[@{/store/modifyMenu}]]",
		data: JSON.stringify(saveModiMenu), dataType: "json", 
		contentType: "application/json",
	});	
	setInterval(function(){window.location.reload();},100);
})
		
})
</script>
<title>修改菜單</title>
</head>
<body>
	<div class="container">
		<h2 class="page-header">修改菜單</h2>
		<table class="table table-bordered table-hover table-striped">
			<thead>
				<tr>
					<th>序號</th>
					<th>菜名</th>
					<th>說明</th>
					<th>價錢</th>
					<th>操作</th>
				</tr>
			</thead>
			<tbody class="info">
				<tr th:each="menu,iterStat:${menuList}">
					<td th:text="${iterStat.count}" class="dishNum"></td>
					<td style="display: none" th:text="${menu.pkDishId}" class="p"></td>
					<td th:text="${menu.dishName}"></td>
					<td th:text="${menu.dishIntroduction}"></td>
					<td th:text="${menu.dishPrice}"></td>
					<td><button class="modify btn btn-primary">修改</button><button class="delete btn btn-danger">刪除</button></td>
				</tr>
			</tbody>
		</table>
		
		<div class="addDishPlace">
		<table id="newDishForm" class="table table-bordered">
		</table>
		<div class="alertEmp">
		</div>
		<button class="btn btn-secondary" hidden="hidden" id="submitButt">送出</button>
		</div>
		
		<div class="buttPlace">
		<button class="addNewLine btn btn-primary">新增菜品</button>
		</div>
	</div>
</body>
</html>